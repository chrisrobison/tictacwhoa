<!doctype html>
<html>
   <head>
      <title>Tic Tac Whoa!</title>
      <style>
         @import url('https://fonts.googleapis.com/css?family=Cabin');
         body { font-size:24px; font-weight: bold; font-family: 'Cabin', sans-serif; padding:0px; margin:0px; }
         table { border-collapse:collapse; margin:0px auto; }
         #gameboard { font-weight: bold; }
         .game_col0, .game_col1 {
            border-right: 1em solid black;
         }
         .game_row0, .game_row1 {
            border-bottom: 1em solid black;
         }
         .row0, .row1 {
            border-bottom: .25em solid black;
         }
         .col0, .col1 {
            border-right: .25em solid black;
         }
         td.cell {
            width: 2em;
            height: 2em;
         }
         td.cell:hover {
            background-color:rgba(0,230,0,.2);
         }
         .disabled td.cell:hover {
            background-color:rgba(0,0,0,0);
         }
         .disabled td.X.cell:hover {
            background-color:rgba(230,230,0,.2);
         }
         .disabled td.O.cell:hover {
            background-color:rgba(0,100,255,.2);
         }
         #gameboard {
            margin-top: .25em;
         }
         #gameboard > tr > td {
            padding:.5em;
         }

         td {
            text-align:center;
            position:relative;
         }
         td.cell.filled:hover {
            background-color:rgba(255,0,0,.2);
         }
         .X {
            background-color:rgba(230,230,0,.2);
         }
         .O {
            background-color:rgba(0,100,255,.2);
         }
         th { background-color:#000; color:#0f0; }
         #currentPlayer { height:2em; }   
         .disabled { background-color: rgba(0,0,0,.5); }
         .XWIN { background-color:#333; }
         .OWIN { background-color:#333; }
         .XWINcell { background-color: rgba(230,230,0,.2); }
         .OWINcell { background-color: rgba(0,100,255,.2); }
         .winImage { position:absolute;top:0px;left:0px;height:100%;opacity:.8; }
         #statusboard { position:relative; height:100%; display:inline-table;}
         #controls { vertical-align:bottom;height:100%;position:relative;font-size:14px;font-weight:normal; text-align:left;line-height:1.5;text-transform:uppercase;}
         button { font-size: 14px; padding: .5em .25em;}
         .DRAW { background-color: #333; }
      </style>
   </head>
   <body>
      <table id="gameboard">
         
      </table>
      <table id="statusboardTemplate" style="display:none">
         <tr>
            <th>Player</th>
         </tr>
         <tr>  
            <td id='currentPlayer'>X</td>
         </tr>
         <tr>
            <td id="controls"> 
               Player 1:<br>
               <select onchange="tictac.player[0]=this.options[this.selectedIndex].value" id='player1'><option>Human</option><option>Computer</option></select><br>
               Player 2:<br>
               <select onchange="tictac.player[1]=this.options[this.selectedIndex].value" id='player2'><option>Human</option><option>Computer</option></select><br><br>
               <button onclick='tictac.init()' id='newgame'>New Game</button>
            </td>
         </tr>
      </table>
   </body>
   <script>
      (function(win) {
         win.tictac = {
            state: {
               turn: 0,
               currentPlayer: 0,
               currentGame: "11",
               currentSymbol: function() { return ['X', 'O'][tictac.state.currentPlayer]; },
               games:{},
               game:{}
            },
            init: function() {
               for (var r=0; r<3; r++) {
                  for (var c=0; c<3; c++) {
                     tictac.state.games["game"+r+""+c] = {};
                     for (var r1=0; r1<3; r1++) {
                        for (var c1=0; c1<3; c1++) {
                           tictac.state.games["game"+r+""+c]["game"+r+""+c+""+r1+""+c1] = "";
                        }
                     }
                  }
               }
               $$("gameboard").innerHTML = "";
               tictac.player = [];
               tictac.player[0] = $$("player1").options[$$("player1").selectedIndex].value;
               tictac.player[1] = $$("player2").options[$$("player2").selectedIndex].value;
               tictac.generateBoard();

               $$("player1").selectedIndex = (tictac.player[0]=="computer") ? 1 : 0;
               $$("player2").selectedIndex = (tictac.player[1]=="computer") ? 1 : 0;
            },
            move: function(spot, player) {
               var tgt = $$(spot),
                   gameInfo = spot.match(/game(\d\d)(\d\d)/);

               if ((gameInfo[1] != tictac.state.currentGame) && (tictac.state.currentGame!="")) {
                  return false;
               }

               if (tictac.state.currentGame=="") {
                  tictac.state.currentGame = gameInfo[1];
               }

               // Take care of DOM stuff first
               tgt.innerHTML = player;
               tgt.classList.add(player);
               
               // Log player move 
               tictac.state.games["game"+tictac.state.currentGame][spot] = player;
               $$('container' + tictac.state.currentGame).classList.add("disabled");
               
               tictac.state.currentGame = gameInfo[2];
               tictac.nextPlayer();
            },
            pickGame: function() {
               var picks = [];
               for (var i in tictac.state.game) {
                  if (tictac.state.game[i]=="") {
                     picks.push(i);
                  }
               }
               var pick = Math.round(Math.random()*(picks.length-1));
               return picks[pick];
            },
            automove: function() {
               if (tictac.state.currentGame == "") {
                  tictac.state.currentGame = tictac.pickGame();
               }

               var picks = [];
               
               for (var i in tictac.state.games["game"+tictac.state.currentGame]) {
                  if (tictac.state.games["game"+tictac.state.currentGame][i]=="") {
                     picks.push(i);
                  }
               }
               var pick = Math.round(Math.random()*(picks.length-1));
               tictac.move(picks[pick], tictac.state.currentSymbol()) 
            },
            nextPlayer: function() {
               tictac.state.currentPlayer ^= 1;
               tictac.state.turn++;

               $$('currentPlayer').innerHTML = tictac.state.currentSymbol();

               tictac.checkGames();
               tictac.clearDisabled();
               tictac.disableAll();
               
              
               if (tictac.state.game[tictac.state.currentGame]=="") {
                  $$('container' + tictac.state.currentGame).classList.remove("disabled");
               } else {
                  tictac.state.currentGame="";
                  tictac.clearDisabled();
               }
               var win = tictac.checkWin();
               if ((tictac.player[tictac.state.currentPlayer]=="Computer") && (!win)) {
                  setTimeout(function() { tictac.automove(); }, 1000);
               }
            },
            click: function(evt) {
               var tgt = evt.target;
               
               tictac.move(tgt.id, tictac.state.currentSymbol());
               
            },
            clearDisabled: function() {
               for (var r=0; r<3; r++) {
                  for (var c=0; c<3; c++) {
                     $$("container"+r+""+c).classList.remove("disabled");
                  }
               }
            },
            disableAll: function() {
               for (var r=0; r<3; r++) {
                  for (var c=0; c<3; c++) {
                     $$("container"+r+""+c).classList.add("disabled");
                  }
               }
            },
            generateBoard: function() {
               var container = document.getElementById("gameboard"),
                   scoreboard = 0;
               for (var r=0; r<3; r++) {
                  var row = document.createElement("tr");
                  row.id = "r"+r;
                  
                  for (var c=0; c<3; c++) {
                     var cell = document.createElement("td");
                     cell.id = "container" + r + "" + c;
                     cell.className = "game_row" + r + " game_col" + c + " disabled";
                     cell.onclick = tictac.click;
                     
                     var g = tictac.makeGame("game" + r + "" + c, tictac.state.games["game" + r + "" + c]);
                     
                     cell.appendChild(g);
                     row.appendChild(cell);
                  }
                  if (!scoreboard) {
                     var cell = document.createElement("td");
                     cell.id="scoreboard";
                     cell.rowSpan = "3";
                     // cell.innerHTML = $$("statusboard").outerHTML;
                     var stat = document.createElement("table");
                     stat.id = "statusboard";
                     stat.innerHTML = $$("statusboardTemplate").innerHTML;
                     cell.appendChild(stat);
                     cell.style = "vertical-align:top;padding:0px;margin:0px;border:2px solid #000;height:100%";
                     //$$("statusboard").parentNode.removeChild($$("statusboard"));
                     row.appendChild(cell);
                     scoreboard = 1;
                  }
                  container.appendChild(row);
               }
               var cg = $$("container" + tictac.state.currentGame);
               cg.classList.remove("disabled");
            },
            makeGame: function(id, game) {
               var container = document.createElement("table");
               container.id = id;

               for (var r=0; r<3; r++) {
                  var row = document.createElement("tr");
                  row.id = id + r;
                  
                  for (var c=0; c<3; c++) {
                     var cell = document.createElement("td");
                     cell.id = id + r + "" + c;
                     cell.className = "cell row" + r + " col" + c;
                     
                     if (game && game[id+r+c]) {
                        cell.innerHTML = game[id+r+c];
                        cell.className += " filled " + game[id+r+c];
                     }
                     // cell.innerHTML = (Math.random()>.5) ? "X" : "O";
                     row.appendChild(cell);
                  }
                  container.appendChild(row);
               }
               return container;   
            },
            checkGames: function() {
               var snapshot = [];
               for (var r=0; r<3; r++) {
                  for (var c=0; c<3; c++) {
                     snapshot[r+""+c] = tictac.checkGame(r + "" + c);
                  }
               }
               tictac.state.game = snapshot;
               console.dir(snapshot);
            },
            checkGame: function(game) {
               var win = false, winner="";

               var rgame = tictac.state.games["game"+game];
               var id = "game"+game;

               // Check for diagnal wins
               if ((rgame[id+"00"]!="") && ((rgame[id+"00"] == rgame[id+"11"]) && (rgame[id+"00"] == rgame[id+"22"]))) {
                  console.log("Diagnal!");
                  winner = rgame[id+"00"];
                  tictac.doWin([id+"00", id+"11", id+"22"], winner);
                  win = true;
               }
               if ((rgame[id+"02"]!="") && ((rgame[id+"02"] == rgame[id+"11"]) && (rgame[id+"02"] == rgame[id+"20"]))) {
                  win = true;
                  winner = rgame[id+"02"];
                  tictac.doWin([id+"02", id+"11", id+"20"], winner);
                  console.log("Diagnal!");
               }
               
               // Check for wins by row and by column
               for (var r=0; r<3; r++) {
                  id = "game"+game+""+r;
                  if ((rgame[id+"0"]!="") && 
                     ((rgame[id+"0"] == rgame[id+"1"]) && 
                      (rgame[id+"0"] == rgame[id+"2"]))) {
                     win = true;
                     winner = rgame[id+"0"];
                     tictac.doWin([id+"0", id+"1", id+"2"], winner);
                     console.log("Won across for " + rgame[id+"0"]);
                  }
                  
                  id = "game"+game;
                  if ((rgame[id+"0"+r]!="") && 
                     ((rgame[id+"0"+r] == rgame[id+"1"+r]) && 
                      (rgame[id+"0"+r] == rgame[id+"2"+r]))) {
                     win = true;
                     winner = rgame[id+"0"+r];
                     tictac.doWin([id+"0"+r, id+"1"+r, id+"2"+r], winner);
                     console.log("Won down for " + rgame[id+"0"+r]+" [id: "+id+"0"+r+"]");
                  }
               }

               var space = 0;
               for (var i in rgame) {
                  if (rgame[i]=="") {
                     space++;
                  }
               }
               if ((space==0) && (!winner)) {
                  winner = "-";
                  $$("container"+game).classList.add("DRAW");
                  $$("container"+game).classList.add("disabled");
               }

               return winner;
            },
            checkWin: function() {
               var win = false, winner="";

               var rgame = tictac.state.game;
               var id = "";

               // Check for diagnal wins
               if ((rgame["00"]!="") && ((rgame["00"] == rgame["11"]) && (rgame["00"] == rgame["22"]))) {
                  console.log("Game Win Diagnal!");
                  winner = rgame["00"];
                  tictac.gameWin(["00", "11", "22"], winner);
                  win = true;
               }
               if ((rgame["02"]!="") && ((rgame["02"] == rgame["11"]) && (rgame["02"] == rgame["20"]))) {
                  win = true;
                  winner = rgame["02"];
                  tictac.gameWin(["02", "11", "20"], winner);
                  console.log("Diagnal!");
               }
               
               // Check for wins by row and by column
               for (var r=0; r<3; r++) {
                  id = r;
                  if ((rgame[id+"0"]!="") && 
                     ((rgame[id+"0"] == rgame[id+"1"]) && 
                      (rgame[id+"0"] == rgame[id+"2"]))) {
                     win = true;
                     winner = rgame[id+"0"];
                     tictac.gameWin([id+"0", id+"1", id+"2"], winner);
                     console.log("Won across for " + rgame[id+"0"]);
                  }
                  
                  id = "";
                  if ((rgame[id+"0"+r]!="") && 
                     ((rgame[id+"0"+r] == rgame[id+"1"+r]) && 
                      (rgame[id+"0"+r] == rgame[id+"2"+r]))) {
                     win = true;
                     winner = rgame[id+"0"+r];
                     tictac.gameWin([id+"0"+r, id+"1"+r, id+"2"+r], winner);
                     console.log("Won down for " + rgame[id+"0"+r]+" [id: "+id+"0"+r+"]");
                  }
               }

               var space = 0;
               for (var i in rgame) {
                  if (rgame[i]=="") {
                     space++;
                  }
               }
               if ((space==0) && (!winner)) {
                  winner = "-";
               }

               return winner;
            },
            gameWin: function(spots, winner) {
               setTimeout(function() { 
                  alert(winner + " Wins!");
                  }, 2000);
            },
            doWin: function(cells,winner) {
               for (var cell in cells) {
                  $$(cells[cell]).classList.add(winner+"WINcell");
               }
               var g = cells[0].match(/game(\d\d)(\d\d)/)[1];
               $$("container"+g).classList.add(winner+"WIN");
               var winImage = document.createElement("img");
               winImage.src = winner + ".png";
               winImage.style = "position:absolute;top:0px;left:0px;height:100%;";
               $$("container"+g).appendChild(winImage);
            }

         }
         window.$$ = $$ = function(el) { return document.getElementById(el); };
            
         tictac.init();
         
      })(window);
   </script>
</html>
